Message Flow/Net
==

在IOT-Tree 1.7.0之前，IOT-Tree尝试了多种方式使用/处理树根采集到的数据。比如，报警模块、任务调入功能、存储支持以及数据路由等。这些模块分别针对一些特定的方面提供了针对采集到的标签Tag数据进行二次处理和使用，但每个功能总是有限。可以想象，如果在后续使用过程中，IOT-Tree要能够提供更强大的树上功能，只会增加更多有限功能模块，这样会使得系统在树枝和树叶层面的应用越来越复杂。

比如，为了使IOT-Tree能够直接支持ERP、MES等系统的数据推送；或者为生产线上的工位提供承上接生产任务，启下对接现场传感器等设备，那么现有的功能模块注定无法满足需要。唯一的实现方式是通过二次开发对接IOT-Tree的实时数据，然后对现场数据实现分析处理并整合到顶层系统中。这样，IOT-Tree在里面的角色仅仅是个OPC Server或IO数据接口，相关应用的实现也会变得很复杂。

为解决以上问题，在1.7.0版本，IOT-Tree引入了重要功能：Message Flow/Net

## 1 整体说明

此功能能够替换前面版本实现的报警模块、任务调度功能、存储功能和数据路由所有功能。其整体思路参考了Node-Red：基于消息Message的方式，建立流程管理。里面的节点Node提供了基础功能，你可以根据需要建立各种消息处理流程/网络，达到顶层各种业务需要。

消息流程以消息为基础，在流程/网络节点中进行传递和处理。这与传统的工作流不同，传统的工作流节点代表了处理过程或工作项，路径可以有上下文数据运行条件，可以自主决定流程走向。同时，这与PLC的梯形图也不同，PLC梯形图路径代表了信号线，节点的粒度可以非常小，基本就是为实现控制逻辑而存在。

虽然，消息流/网络参考了Node-Red，但与之也不相同。Node-Red基于Node.js提供了各种基础节点，基本思路是基于消息替代消息处理代码编程。相关节点功能粒度也很细，但整体流程网络运行又偏向屏蔽复杂的底层。这造成了一点的矛盾——如果要实现简单功能问题不大，但如果要实现复杂的业务路径，可能会造成网络很庞大，失去了直观性（有可能还不如直接写代码，这是我个人观点，如果我理解不对请对我指出批评）。

综合各种流程的利弊，IOT-Tree基于消息的流程提供如下策略：

1) 充分利用消息流程的直观性，简化开发。

2) 避免流程太庞大，尽可能提供<font color=green>中粒度节点：节点功能尽可能独立但不划分太细</font>

3) 支持现场控制，提供异步运行节点，并能够支持流程中直观观察运行状态。

4) 支持上下文数据直观展示，使得用户可以对流程运行有着更好的把控

5) 支持标准的java webapp开发方式，提供业务节点插件，使得系统能够无限扩展，并且能够应付各种千变万化的需要。

至此，IOT-Tree从架构上可以认为是两个功能：一个是树根功能接入各种设备传感器，并形成统一规整的数据；一个就是树上消息流程/网络，可以为各种复杂的业务功能提供强大高效率的支持，同时保持模块之间轻耦合。

<img src="../img/msgnet/mn001.png">

## 2 消息流/网络组成

如果你对Node-Red有过了解，那么理解IOT-Tree的消息流/网络也会更容易。不过，虽然思路类似，但IOT-Tree提供的相关基础有着很大的差异。

### 2.1 项目、流程、节点三个层次

### 2.2 流程 Flow

### 2.3 节点和路径

### 2.3.1 节点类型

### 2.3.2 路径



